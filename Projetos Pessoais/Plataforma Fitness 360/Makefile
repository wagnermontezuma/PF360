.PHONY: setup infra up down restart logs clean frontend-aluno frontend-staff auth-api members-api all-apis reset-all help status update healthcheck test-integration monitoring monitoring-setup monitoring-up monitoring-down monitoring-exporters monitoring-dashboard docs beta-env beta-launch beta-healthcheck

# ConfiguraÃ§Ãµes
SHELL := /bin/bash
MAKEFILE_PATH := $(abspath $(lastword $(MAKEFILE_LIST)))
PROJECT_DIR := $(dir $(MAKEFILE_PATH))

help:
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘             PLATAFORMA FITNESS 360           â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "Comandos disponÃ­veis:"
	@echo "  make setup         - Configura o ambiente inicial (requer apenas uma vez)"
	@echo "  make infra         - Inicia apenas a infraestrutura (bancos, Kafka, Redis)"
	@echo "  make up            - Inicia todo o ambiente (infraestrutura + APIs)"
	@echo "  make down          - Para todos os contÃªineres"
	@echo "  make restart       - Reinicia todos os contÃªineres"
	@echo "  make logs [svc=X]  - Mostra logs (ex: make logs svc=auth-svc)"
	@echo "  make status        - Verifica status dos serviÃ§os"
	@echo "  make healthcheck   - Executa verificaÃ§Ã£o de saÃºde completa"
	@echo "  make test-integration - Executa testes de integraÃ§Ã£o entre serviÃ§os"
	@echo ""
	@echo "Iniciar componentes individuais:"
	@echo "  make frontend-aluno - Inicia o frontend do aluno"
	@echo "  make frontend-staff - Inicia o frontend do staff"
	@echo "  make auth-api       - Inicia apenas o serviÃ§o de autenticaÃ§Ã£o"
	@echo "  make members-api    - Inicia apenas o serviÃ§o de membros"
	@echo "  make all-apis       - Inicia todos os serviÃ§os de API"
	@echo ""
	@echo "Ambiente Beta:"
	@echo "  make beta-env       - Configura ambiente beta para testes"
	@echo "  make beta-launch [grupo=X] - LanÃ§a recursos beta para um grupo especÃ­fico"
	@echo "                      (grupo=grupo-a|grupo-b|grupo-c|grupo-d|all)"
	@echo "  make beta-healthcheck - Verifica a saÃºde do ambiente beta"
	@echo ""
	@echo "Monitoramento:"
	@echo "  make monitoring     - Configura e inicia todo o sistema de monitoramento"
	@echo "  make monitoring-up  - Inicia apenas os serviÃ§os de monitoramento"
	@echo "  make monitoring-down - Para os serviÃ§os de monitoramento"
	@echo ""
	@echo "ManutenÃ§Ã£o:"
	@echo "  make clean         - Remove todos os contÃªineres e volumes"
	@echo "  make update        - Atualiza as dependÃªncias"
	@echo "  make reset-all     - Reset completo (remove + recria)"
	@echo "  make docs          - Gera documentaÃ§Ã£o atualizada da plataforma"

setup:
	@echo "ğŸ”§ Configurando ambiente inicial..."
	@chmod +x $(PROJECT_DIR)/scripts/podman-up.sh
	@chmod +x $(PROJECT_DIR)/scripts/start-microservices.sh
	@chmod +x $(PROJECT_DIR)/scripts/healthcheck.sh
	@chmod +x $(PROJECT_DIR)/scripts/update-dependencies.sh
	@chmod +x $(PROJECT_DIR)/scripts/test-integration.sh
	@chmod +x $(PROJECT_DIR)/scripts/setup-monitoring.sh
	@chmod +x $(PROJECT_DIR)/scripts/start-monitoring-exporters.sh
	@chmod +x $(PROJECT_DIR)/scripts/setup-beta-env.sh
	@chmod +x $(PROJECT_DIR)/scripts/launch-beta-group.sh
	@chmod +x $(PROJECT_DIR)/scripts/beta-healthcheck.sh
	@pnpm install
	@podman network exists fitness360-network || podman network create fitness360-network
	@mkdir -p ~/.local/share/containers/storage/volumes/{auth_postgres_data,members_postgres_data,billing_postgres_data,feedback_postgres_data,kafka_data,zookeeper_data,redis_data}
	@echo "âœ… Ambiente configurado!"

infra:
	@echo "ğŸš€ Iniciando infraestrutura..."
	@bash $(PROJECT_DIR)/scripts/podman-up.sh

up: infra
	@echo "ğŸš€ Iniciando todas as APIs..."
	@bash $(PROJECT_DIR)/scripts/start-microservices.sh

down:
	@echo "ğŸ›‘ Parando todos os contÃªineres..."
	@podman-compose -f $(PROJECT_DIR)/podman-compose.yml down || true
	@podman stop $(shell podman ps -a -q --filter "name=fitness360-*") 2>/dev/null || true
	@podman stop auth-svc members-svc billing-svc feedback-svc 2>/dev/null || true
	@echo "âœ… Todos os contÃªineres parados!"

restart: down up

logs:
	@if [ -z "$(svc)" ]; then \
		echo "Informe o serviÃ§o para visualizar os logs: make logs svc=auth-svc"; \
	else \
		podman logs -f $(svc); \
	fi

clean: down
	@echo "ğŸ§¹ Limpando ambiente..."
	@podman rm $(shell podman ps -a -q --filter "name=fitness360-*") 2>/dev/null || true
	@podman rm auth-svc members-svc billing-svc feedback-svc 2>/dev/null || true
	@podman rm prometheus grafana alertmanager node-exporter cadvisor kafka-exporter 2>/dev/null || true
	@podman volume rm $(shell podman volume ls -q --filter "name=fitness360-*") 2>/dev/null || true
	@echo "âœ… Ambiente limpo!"

status:
	@echo "ğŸ“Š Status dos serviÃ§os:"
	@echo "=========================="
	@echo "ğŸ”µ Infraestrutura:"
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=fitness360-*" || true
	@echo ""
	@echo "ğŸ”µ MicrosserviÃ§os:"
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=auth-svc" || true
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=members-svc" || true
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=billing-svc" || true
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=feedback-svc" || true
	@echo ""
	@echo "ğŸ”µ Monitoramento:"
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=prometheus" || true
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=grafana" || true
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=alertmanager" || true
	@podman ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" --filter "name=node-exporter" || true

healthcheck:
	@echo "ğŸ©º Verificando saÃºde da plataforma..."
	@bash $(PROJECT_DIR)/scripts/healthcheck.sh

test-integration:
	@echo "ğŸ§ª Executando testes de integraÃ§Ã£o..."
	@bash $(PROJECT_DIR)/scripts/test-integration.sh

frontend-aluno:
	@echo "ğŸš€ Iniciando frontend do aluno..."
	@cd $(PROJECT_DIR)/frontend/app-aluno && pnpm dev

frontend-staff:
	@echo "ğŸš€ Iniciando frontend do staff..."
	@cd $(PROJECT_DIR)/frontend/app-staff && pnpm dev

auth-api:
	@echo "ğŸš€ Iniciando serviÃ§o de autenticaÃ§Ã£o..."
	@cd $(PROJECT_DIR) && bash scripts/start-microservices.sh auth-svc

members-api:
	@echo "ğŸš€ Iniciando serviÃ§o de membros..."
	@cd $(PROJECT_DIR) && bash scripts/start-microservices.sh members-svc

all-apis:
	@echo "ğŸš€ Iniciando todos os serviÃ§os de API..."
	@cd $(PROJECT_DIR) && bash scripts/start-microservices.sh

update:
	@echo "ğŸ”„ Atualizando dependÃªncias..."
	@bash $(PROJECT_DIR)/scripts/update-dependencies.sh

reset-all: clean setup up
	@echo "âœ… Ambiente completamente reiniciado!"

docs:
	@echo "ğŸ“š Gerando documentaÃ§Ã£o atualizada..."
	@if [ ! -d "$(PROJECT_DIR)/docs/api" ]; then \
		mkdir -p $(PROJECT_DIR)/docs/api; \
	fi
	@echo "âœ… Gerando documentaÃ§Ã£o de API..."
	@for service in auth-svc members-svc billing-svc feedback-svc; do \
		if [ -d "$(PROJECT_DIR)/backend/$$service" ]; then \
			cd $(PROJECT_DIR)/backend/$$service && \
			if grep -q "\"compodoc\"" "package.json"; then \
				echo "Gerando documentaÃ§Ã£o para $$service"; \
				pnpm compodoc -p tsconfig.json -d ../../docs/api/$$service; \
			else \
				echo "Pulando $$service (compodoc nÃ£o configurado)"; \
			fi; \
		fi; \
	done
	@echo "âœ… DocumentaÃ§Ã£o gerada com sucesso!"
	@echo "ğŸ“– Abra a documentaÃ§Ã£o em seu navegador:"
	@echo "  - API Auth: file://$(PROJECT_DIR)/docs/api/auth-svc/index.html"
	@echo "  - API Members: file://$(PROJECT_DIR)/docs/api/members-svc/index.html"
	@echo "  - Exemplos de Monitoramento: $(PROJECT_DIR)/docs/examples/monitoring"

# Comandos para monitoramento
monitoring-setup:
	@echo "ğŸ”§ Configurando sistema de monitoramento..."
	@bash $(PROJECT_DIR)/scripts/setup-monitoring.sh
	@echo "âœ… Sistema de monitoramento configurado!"

monitoring-up:
	@echo "ğŸš€ Iniciando serviÃ§os de monitoramento..."
	@podman run -d --name prometheus \
		--network fitness360-network \
		-p 9090:9090 \
		-v $(PROJECT_DIR)/prometheus/config:/etc/prometheus \
		-v $(PROJECT_DIR)/prometheus/data:/prometheus \
		prom/prometheus:latest
	@podman run -d --name grafana \
		--network fitness360-network \
		-p 3000:3000 \
		-v $(PROJECT_DIR)/grafana/config:/etc/grafana \
		-v $(PROJECT_DIR)/grafana/dashboards:/var/lib/grafana/dashboards \
		-v $(PROJECT_DIR)/grafana/data:/var/lib/grafana/data \
		grafana/grafana:latest
	@podman run -d --name alertmanager \
		--network fitness360-network \
		-p 9093:9093 \
		-v $(PROJECT_DIR)/alertmanager/config:/etc/alertmanager \
		-v $(PROJECT_DIR)/alertmanager/data:/alertmanager \
		prom/alertmanager:latest
	@echo "âœ… ServiÃ§os de monitoramento iniciados!"

monitoring-exporters:
	@echo "ğŸš€ Iniciando exporters para monitoramento..."
	@bash $(PROJECT_DIR)/scripts/start-monitoring-exporters.sh
	@echo "âœ… Exporters iniciados!"

monitoring-down:
	@echo "ğŸ›‘ Parando serviÃ§os de monitoramento..."
	@podman stop prometheus grafana alertmanager node-exporter cadvisor kafka-exporter || true
	@podman rm prometheus grafana alertmanager node-exporter cadvisor kafka-exporter || true
	@echo "âœ… ServiÃ§os de monitoramento parados!"

monitoring-dashboard:
	@echo "ğŸ”— Abrindo dashboard do Grafana no navegador..."
	@xdg-open http://localhost:3000 || open http://localhost:3000 || echo "Abra manualmente: http://localhost:3000"

monitoring: monitoring-setup monitoring-up monitoring-exporters
	@echo "âœ… Monitoramento completo configurado e iniciado!"

# Comandos para ambiente beta
beta-env:
	@echo "ğŸ§ª Configurando ambiente beta..."
	@if [ ! -x "$(PROJECT_DIR)/scripts/setup-beta-env.sh" ]; then \
		chmod +x $(PROJECT_DIR)/scripts/setup-beta-env.sh; \
	fi
	@sudo $(PROJECT_DIR)/scripts/setup-beta-env.sh
	@echo "âœ… Ambiente beta configurado com sucesso!"

beta-launch:
	@echo "ğŸš€ LanÃ§ando recursos beta para grupo especÃ­fico..."
	@if [ -z "$(grupo)" ]; then \
		echo "âŒ Erro: Grupo nÃ£o especificado"; \
		echo "Uso: make beta-launch grupo=GRUPO"; \
		echo "Grupos disponÃ­veis: grupo-a, grupo-b, grupo-c, grupo-d, all"; \
		exit 1; \
	fi
	@if [ ! -x "$(PROJECT_DIR)/scripts/launch-beta-group.sh" ]; then \
		chmod +x $(PROJECT_DIR)/scripts/launch-beta-group.sh; \
	fi
	@$(PROJECT_DIR)/scripts/launch-beta-group.sh $(grupo)
	@echo "âœ… Recursos beta lanÃ§ados para o grupo $(grupo)!"

beta-healthcheck:
	@echo "ğŸ©º Verificando saÃºde do ambiente beta..."
	@if [ ! -x "./scripts/beta-healthcheck.sh" ]; then \
		chmod +x ./scripts/beta-healthcheck.sh; \
	fi
	@./scripts/beta-healthcheck.sh
	@echo "âœ… VerificaÃ§Ã£o de saÃºde do ambiente beta concluÃ­da!" 